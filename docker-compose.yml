
services:
  # Main application
  app:
    image: lc:latest
    build: .
    ports:
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./.prod.env:/app/.prod.env:ro
    environment:
      - SANDBOX_CONTAINER=lc-sandbox
    depends_on:
      sandbox:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - lc-network

  # Test service
  test:
    profiles:
      - test
    build:
      context: .
      target: builder
    volumes:
      - .:/app
      - go-mod-cache:/go/pkg/mod
      - /var/run/docker.sock:/var/run/docker.sock
    working_dir: /app
    environment:
      - SANDBOX_CONTAINER=lc-sandbox
    command: go test -v -race -coverprofile=coverage.out ./tests/... ./internal/...
    networks:
      - lc-network
    depends_on:
      - sandbox
    # Service only runs when explicitly invoked with 'docker-compose run --profile test test'

  # Sandbox container for code execution
  sandbox:
    image: golang:1.23-alpine
    container_name: lc-sandbox
    command: sh -c "apk add --no-cache python3 py3-pip coreutils && python3 --version && sleep infinity"
    mem_limit: 512m
    cpus: '0.5'
    pids_limit: 100
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: false
    tmpfs:
      - /tmp:rw,exec,size=200m
      - /go:rw,exec,size=300m
    restart: unless-stopped
    networks:
      - lc-network
    healthcheck:
      test: ["CMD", "sh", "-c", "test -f /tmp || mkdir -p /tmp"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

volumes:
  go-mod-cache:

networks:
  lc-network:
    driver: bridge
