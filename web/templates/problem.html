{{define "problem-title"}}{{.Title}} - LeetCode Clone{{end}}
{{define "problem-content"}}
<div class="container">
    <div class="problem-header">
        <h2>{{.Title}} <span class="difficulty difficulty-{{.Difficulty}}">{{.Difficulty}}</span></h2>
        <a href="/">← Back to Problems</a>
    </div>
    
    <div class="problem-content">
        <div class="description">
            <h3>Description</h3>
            <p>{{.Description}}</p>
            <h3>Function Signature</h3>
            <pre><code id="function-signature" class="language-go">{{.Signature}}</code></pre>
            <h3>Test Cases</h3>
            <ul>
                {{range .TestCases}}
                <li>
                    <strong>Input:</strong> {{.Input}}<br>
                    <strong>Expected:</strong> {{.Expected}}
                </li>
                {{end}}
            </ul>
        </div>
        
        <div class="editor-section">
            <form id="code-form" hx-post="/run/{{.ID}}" hx-target="#result" hx-swap="innerHTML">
                <div style="margin-bottom: 10px;">
                    <label for="language-select" style="margin-right: 10px; color: #ccc;">Language:</label>
                    <select id="language-select" name="language" style="padding: 5px; background: #272822; color: #f8f8f2; border: 1px solid #555; border-radius: 3px;">
                        <option value="go">Go</option>
                        <option value="python">Python 3</option>
                    </select>
                </div>
                <textarea id="code-editor" name="code" class="code-editor" placeholder="// Write your solution here&#10;{{.Signature}} {&#10;    &#10;}" required>{{.Signature}} {
    
}</textarea>
                <div class="button-group">
                    <button type="button" id="run-btn" name="action" value="test">Run</button>
                    <button type="submit" name="action" value="submit">Submit</button>
                    <button type="button" id="solution-btn" onclick="toggleSolution({{.ID}})" style="background: #5a5a5a;">Show Solution</button>
                </div>
            </form>
            <div id="result"></div>
        </div>
        
        <div id="solution" class="solution-panel"></div>
        <script>
            // Global function to load solution with language
            function loadSolution(id, lang) {
                // #region agent log
                var url = '/solution/' + id + '?lang=' + lang;
                fetch('http://127.0.0.1:7242/ingest/cc6be576-614c-48cb-ab78-fc47ce9cf38e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'problem.html:51',message:'loadSolution fetch start',data:{url:url,id:id,lang:lang},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
                // #endregion
                fetch(url)
                    .then(response => {
                        // #region agent log
                        fetch('http://127.0.0.1:7242/ingest/cc6be576-614c-48cb-ab78-fc47ce9cf38e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'problem.html:53',message:'loadSolution response received',data:{url:url,status:response.status,statusText:response.statusText,ok:response.ok},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
                        // #endregion
                        return response.text();
                    })
                    .then(html => {
                        // The response includes the full solution div, so we extract its innerHTML
                        var tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;
                        var solutionContent = tempDiv.querySelector('.solution');
                        if (solutionContent) {
                            document.getElementById('solution').innerHTML = solutionContent.innerHTML;
                            // Execute any scripts from the response
                            var scripts = solutionContent.querySelectorAll('script');
                            scripts.forEach(function(oldScript) {
                                var newScript = document.createElement('script');
                                Array.from(oldScript.attributes).forEach(function(attr) {
                                    newScript.setAttribute(attr.name, attr.value);
                                });
                                newScript.textContent = oldScript.textContent;
                                document.head.appendChild(newScript);
                            });
                        } else {
                            document.getElementById('solution').innerHTML = html;
                        }
                        // Apply syntax highlighting
                        if (typeof CodeMirror !== 'undefined') {
                            setTimeout(function() {
                                var solutionCode = document.querySelector('#solution code');
                                if (solutionCode) {
                                    CodeMirror.runMode(solutionCode.textContent, lang, solutionCode);
                                }
                            }, 100);
                        }
                    })
                    .catch(function(error) {
                        // #region agent log
                        fetch('http://127.0.0.1:7242/ingest/cc6be576-614c-48cb-ab78-fc47ce9cf38e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'problem.html:83',message:'loadSolution fetch error',data:{url:url,errorName:error.name,errorMessage:error.message,errorStack:error.stack},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
                        // #endregion
                        console.error('Error loading solution:', error);
                    });
            }
            
            var solutionOpen = false;
            var solutionProblemId = null;
            
            function toggleSolution(problemId) {
                var solutionPanel = document.getElementById('solution');
                var btn = document.getElementById('solution-btn');
                var content = document.querySelector('.problem-content');
                
                if (solutionOpen && solutionProblemId === problemId) {
                    // Close solution
                    solutionPanel.innerHTML = '';
                    content.classList.remove('solution-open');
                    btn.textContent = 'Show Solution';
                    solutionOpen = false;
                    solutionProblemId = null;
                } else {
                    // Open solution - use current language selection
                    var lang = document.getElementById('language-select').value;
                    // #region agent log
                    var url2 = '/solution/' + problemId + '?lang=' + lang;
                    fetch('http://127.0.0.1:7242/ingest/cc6be576-614c-48cb-ab78-fc47ce9cf38e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'problem.html:106',message:'toggleSolution fetch start',data:{url:url2,problemId:problemId,lang:lang},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
                    // #endregion
                    fetch(url2)
                        .then(function(response) {
                            // #region agent log
                            fetch('http://127.0.0.1:7242/ingest/cc6be576-614c-48cb-ab78-fc47ce9cf38e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'problem.html:107',message:'toggleSolution response received',data:{url:url2,status:response.status,statusText:response.statusText,ok:response.ok},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
                            // #endregion
                            return response.text();
                        })
                        .then(function(html) {
                            solutionPanel.innerHTML = html;
                            content.classList.add('solution-open');
                            btn.textContent = 'Hide Solution';
                            solutionOpen = true;
                            solutionProblemId = problemId;
                            highlightCode();
                        })
                        .catch(function(error) {
                            // #region agent log
                            fetch('http://127.0.0.1:7242/ingest/cc6be576-614c-48cb-ab78-fc47ce9cf38e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'problem.html:116',message:'toggleSolution fetch error',data:{url:url2,errorName:error.name,errorMessage:error.message,errorStack:error.stack},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
                            // #endregion
                            console.error('Error loading solution:', error);
                        });
                }
            }
            
            var editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
                lineNumbers: true,
                mode: 'go',
                theme: 'monokai',
                indentUnit: 4,
                indentWithTabs: false,
                lineWrapping: true,
                autofocus: true
            });
            
            // Initialize signature highlighting
            if (typeof CodeMirror !== 'undefined') {
                setTimeout(function() {
                    var signatureEl = document.getElementById('function-signature');
                    if (signatureEl) {
                        CodeMirror.runMode(signatureEl.textContent, 'go', signatureEl);
                    }
                }, 100);
            }
            
            // Convert Go signature to Python signature
            function goToPythonSignature(goSig) {
                // Remove 'func ' prefix
                var sig = goSig.replace(/^func\s+/, '');
                // Extract function name (everything before first '(')
                var match = sig.match(/^(\w+)\s*\(/);
                if (!match) return 'def solution():\n    pass';
                var funcName = match[1];
                // Extract parameters
                var paramsMatch = sig.match(/\(([^)]*)\)/);
                var params = [];
                if (paramsMatch && paramsMatch[1].trim()) {
                    var paramParts = paramsMatch[1].split(',');
                    paramParts.forEach(function(p) {
                        p = p.trim();
                        var parts = p.split(/\s+/);
                        if (parts.length >= 2) {
                            var paramName = parts[0];
                            var paramType = parts[1];
                            // Convert Go types to Python types
                            var pyType = paramType
                                .replace(/\[\]int/g, 'List[int]')
                                .replace(/\[\]string/g, 'List[str]')
                                .replace(/\[\]byte/g, 'List[str]')
                                .replace(/\[\]\*ListNode/g, 'List[Optional[ListNode]]')
                                .replace(/\*ListNode/g, 'Optional[ListNode]')
                                .replace(/\*TreeNode/g, 'Optional[TreeNode]')
                                .replace(/int/g, 'int')
                                .replace(/string/g, 'str')
                                .replace(/bool/g, 'bool')
                                .replace(/float64/g, 'float');
                            params.push(paramName + ': ' + pyType);
                        }
                    });
                }
                // Extract return type
                var returnType = 'None';
                if (sig.includes(') []int')) {
                    returnType = 'List[int]';
                } else if (sig.includes(') []string')) {
                    returnType = 'List[str]';
                } else if (sig.includes(') string')) {
                    returnType = 'str';
                } else if (sig.includes(') int')) {
                    returnType = 'int';
                } else if (sig.includes(') bool')) {
                    returnType = 'bool';
                } else if (sig.includes(') float64')) {
                    returnType = 'float';
                } else if (sig.includes(') *ListNode')) {
                    returnType = 'Optional[ListNode]';
                } else if (sig.includes(') *TreeNode')) {
                    returnType = 'Optional[TreeNode]';
                }
                var pySig = 'def ' + funcName + '(' + params.join(', ') + ') -> ' + returnType + ':\n    pass';
                return pySig;
            }
            
            // Handle language change
            document.getElementById('language-select').addEventListener('change', function() {
                var lang = this.value;
                editor.setOption('mode', lang);
                
                // Update function signature display
                var signatureEl = document.getElementById('function-signature');
                if (signatureEl) {
                    var goSig = '{{.Signature}}';
                    if (lang === 'python') {
                        var pySig = goToPythonSignature(goSig);
                        signatureEl.textContent = pySig;
                        signatureEl.className = 'language-python';
                    } else {
                        signatureEl.textContent = goSig;
                        signatureEl.className = 'language-go';
                    }
                    // Re-apply syntax highlighting
                    if (typeof CodeMirror !== 'undefined') {
                        CodeMirror.runMode(signatureEl.textContent, lang, signatureEl);
                    }
                }
                
                // Update placeholder based on language
                if (lang === 'python') {
                    var goSig = '{{.Signature}}';
                    var pySig = goToPythonSignature(goSig);
                    editor.setValue(pySig);
                } else {
                    editor.setValue('{{.Signature}} {\n    \n}');
                }
                // If solution is open, reload it with new language
                if (solutionOpen && solutionProblemId === {{.ID}}) {
                    // #region agent log
                    var url3 = '/solution/{{.ID}}?lang=' + lang;
                    fetch('http://127.0.0.1:7242/ingest/cc6be576-614c-48cb-ab78-fc47ce9cf38e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'problem.html:233',message:'language change fetch start',data:{url:url3,problemId:{{.ID}},lang:lang},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});
                    // #endregion
                    fetch(url3)
                        .then(function(response) {
                            // #region agent log
                            fetch('http://127.0.0.1:7242/ingest/cc6be576-614c-48cb-ab78-fc47ce9cf38e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'problem.html:234',message:'language change response received',data:{url:url3,status:response.status,statusText:response.statusText,ok:response.ok},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});
                            // #endregion
                            return response.text();
                        })
                        .then(function(html) {
                            var tempDiv = document.createElement('div');
                            tempDiv.innerHTML = html;
                            var solutionContent = tempDiv.querySelector('.solution');
                            if (solutionContent) {
                                document.getElementById('solution').innerHTML = solutionContent.innerHTML;
                                var scripts = solutionContent.querySelectorAll('script');
                                scripts.forEach(function(oldScript) {
                                    var newScript = document.createElement('script');
                                    Array.from(oldScript.attributes).forEach(function(attr) {
                                        newScript.setAttribute(attr.name, attr.value);
                                    });
                                    newScript.textContent = oldScript.textContent;
                                    document.head.appendChild(newScript);
                                });
                            } else {
                                document.getElementById('solution').innerHTML = html;
                            }
                            if (typeof CodeMirror !== 'undefined') {
                                setTimeout(function() {
                                    var solutionCode = document.querySelector('#solution code');
                                    if (solutionCode) {
                                        CodeMirror.runMode(solutionCode.textContent, lang, solutionCode);
                                    }
                                }, 100);
                            }
                        })
                        .catch(function(error) {
                            // #region agent log
                            fetch('http://127.0.0.1:7242/ingest/cc6be576-614c-48cb-ab78-fc47ce9cf38e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'problem.html:262',message:'language change fetch error',data:{url:url3,errorName:error.name,errorMessage:error.message,errorStack:error.stack},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});
                            // #endregion
                            console.error('Error reloading solution:', error);
                        });
                }
            });
            
            document.getElementById('code-form').addEventListener('submit', function(e) {
                var code = editor.getValue();
                document.getElementById('code-editor').value = code;
                // Add language to form
                var langInput = document.createElement('input');
                langInput.type = 'hidden';
                langInput.name = 'language';
                langInput.value = document.getElementById('language-select').value;
                this.appendChild(langInput);
            });
            
            // Handle Run button with streaming
            document.getElementById('run-btn').addEventListener('click', function() {
                var code = editor.getValue();
                var problemId = {{.ID}};
                var resultDiv = document.getElementById('result');
                var btn = this;
                
                // Disable button during execution
                btn.disabled = true;
                btn.textContent = 'Running...';
                
                // Clear previous results and show streaming output
                resultDiv.innerHTML = '<div class="result"><div class="streaming-output"><h3>Running Tests...</h3><pre class="output-log code-output" id="stream-log"></pre></div></div>';
                var logPre = document.getElementById('stream-log');
                
                // Create form data
                var formData = new FormData();
                formData.append('code', code);
                formData.append('action', 'test');
                formData.append('language', document.getElementById('language-select').value);
                
                // Create abort controller for timeout
                var controller = new AbortController();
                var timeoutId = setTimeout(function() {
                    controller.abort();
                }, 60000); // 60 second timeout
                
                // Fetch with streaming
                // #region agent log
                var url4 = '/run/' + problemId + '?stream=true';
                fetch('http://127.0.0.1:7242/ingest/cc6be576-614c-48cb-ab78-fc47ce9cf38e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'problem.html:307',message:'run button fetch start',data:{url:url4,problemId:problemId,method:'POST',hasSignal:!!controller.signal},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
                // #endregion
                fetch(url4, {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                }).then(function(response) {
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/cc6be576-614c-48cb-ab78-fc47ce9cf38e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'problem.html:311',message:'run button response received',data:{url:url4,status:response.status,statusText:response.statusText,ok:response.ok,contentType:response.headers.get('content-type')},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
                    // #endregion
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        return response.text().then(function(text) {
                            throw new Error('Request failed: ' + response.status + ' - ' + text);
                        });
                    }
                    
                    var reader = response.body.getReader();
                    var decoder = new TextDecoder();
                    var buffer = '';
                    var finalResult = null;
                    
                    function readStream() {
                        reader.read().then(function(result) {
                            if (result.done) {
                                // Stream ended, show final result from finalResult variable
                                if (finalResult) {
                                    var summaryHtml = '<div class="summary">';
                                    if (finalResult.success) {
                                        summaryHtml += '<p style="color: green;">✓ Success! ' + finalResult.passed + '/' + finalResult.total + ' tests passed</p>';
                                    } else {
                                        summaryHtml += '<p style="color: red;">✗ Failed: ' + finalResult.passed + '/' + finalResult.total + ' tests passed</p>';
                                    }
                                    summaryHtml += '</div>';
                                    logPre.insertAdjacentHTML('afterend', summaryHtml);
                                }
                                btn.disabled = false;
                                btn.textContent = 'Run';
                                return;
                            }
                            
                            buffer += decoder.decode(result.value, {stream: true});
                            var lines = buffer.split('\n');
                            buffer = lines.pop() || '';
                            
                            lines.forEach(function(line) {
                                if (line.startsWith('data: ')) {
                                    var data = line.substring(6);
                                    // Check if this is the final result JSON
                                    if (data.trim().startsWith('{') && data.includes('success')) {
                                        try {
                                            finalResult = JSON.parse(data);
                                        } catch (e) {
                                            // Not JSON, treat as regular output
                                            data = data.replace(/\\n/g, '\n').replace(/\\r/g, '\r').replace(/\\\\/g, '\\');
                                            logPre.textContent += data + '\n';
                                        }
                                    } else {
                                        // Unescape SSE data
                                        data = data.replace(/\\n/g, '\n').replace(/\\r/g, '\r').replace(/\\\\/g, '\\');
                                        logPre.textContent += data + '\n';
                                    }
                                    logPre.scrollTop = logPre.scrollHeight;
                                } else if (line.startsWith('event: done')) {
                                    // Execution complete marker
                                }
                            });
                            
                            readStream();
                        }).catch(function(error) {
                            logPre.textContent += '\n[Error reading stream: ' + error.message + ']';
                            btn.disabled = false;
                            btn.textContent = 'Run';
                        });
                    }
                    
                    readStream();
                }).catch(function(error) {
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/cc6be576-614c-48cb-ab78-fc47ce9cf38e',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'problem.html:379',message:'run button fetch error',data:{url:url4,errorName:error.name,errorMessage:error.message,errorStack:error.stack,isAbortError:error.name==='AbortError'},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
                    // #endregion
                    clearTimeout(timeoutId);
                    var errorMsg = error.message;
                    if (error.name === 'AbortError') {
                        errorMsg = 'Request timed out after 60 seconds. The code may be taking too long to execute or there may be an infinite loop.';
                    }
                    resultDiv.innerHTML = '<div class="error"><h3>Error</h3><pre>' + errorMsg + '</pre></div>';
                    btn.disabled = false;
                    btn.textContent = 'Run';
                    console.error('Run error:', error);
                });
            });
        </script>
    </div>
</div>
{{end}}
{{define "title"}}{{template "problem-title" .}}{{end}}
{{define "content"}}{{template "problem-content" .}}{{end}}
{{template "layout.html" .}}
